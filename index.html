<!DOCTYPE html>

<html>

<head>
    <title> University District Crime Map & Statistics </title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width = device-width, initial-scale = 1">
    <link rel="stylesheet" type="text/css" href="index.css">
    <link href="https://fonts.googleapis.com/css?family=Fredericka+the+Great" rel="stylesheet">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script>
        L_PREFER_CANVAS = false;
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    <script src="df_udist.geojson" type="text/javascript"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />
    <link rel="stylesheet" href="https://rawgit.com/python-visualization/folium/master/folium/templates/leaflet.awesome.rotate.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.Default.css" />
</head>

<body onload="initMap();">
    <div class="head-banner">
        <span id="websiteTitle"> U-District Crime Map & Statistics </span>
    </div>
    <div class="tool-bar">
        <div class="tool" id="totalCount">Total Number of Incidents<br>
            <output id="totalCountOut">0</output>
        </div>
        <div class="multiselect" onmouseleave="hideCheckboxes()">
            <div class="selectBox" onclick="showCheckboxes()">
                <select><option>Select Offense Types</option></select>
                <div class="overSelect"></div>
            </div>
            <div id="checkboxes">
                <label for="otall"><input type="checkbox" onClick="toggle(this)" /> Select All</label>
                <label for="ot1"><input class="otypes" type="checkbox" id="ot1" value="ANIMAL COMPLAINT" /> Animal Complaint</label>
                <label for="ot2"><input class="otypes" type="checkbox" id="ot2" value="ASSAULT" /> Assault</label>
                <label for="ot3"><input class="otypes" type="checkbox" id="ot3" value="BIAS INCIDENT" /> Bias Incident</label>
                <label for="ot4"><input class="otypes" type="checkbox" id="ot4" value="BIKE THEFT" /> Bike Theft</label>
                <label for="ot5"><input class="otypes" type="checkbox" id="ot5" value="BURGLARY" /> Burglary</label>
                <label for="ot6"><input class="otypes" type="checkbox" id="ot6" value="CAR PROWL" /> Car Prowl</label>
                <label for="ot7"><input class="otypes" type="checkbox" id="ot7" value="COUNTERFEIT" /> Counterfeit</label>
                <label for="ot8"><input class="otypes" type="checkbox" id="ot8" value="DISORDERLY CONDUCT" /> Disorderly Conduct</label>
                <label for="ot9"><input class="otypes" type="checkbox" id="ot9" value="DISPUTE" /> Dispute</label>
                <label for="ot10"><input class="otypes" type="checkbox" id="ot10" value="DISTURBANCE" /> Disturbance</label>
                <label for="ot11"><input class="otypes" type="checkbox" id="ot11" value="DUI" /> DUI</label>
                <label for="ot12"><input class="otypes" type="checkbox" id="ot12" value="ELUDING" /> Eluding</label>
                <label for="ot13"><input class="otypes" type="checkbox" id="ot13" value="EMBEZZLE" /> Embezzle</label>
                <label for="ot14"><input class="otypes" type="checkbox" id="ot14" value="EXTORTION" /> Extortion</label>
                <label for="ot15"><input class="otypes" type="checkbox" id="ot15" value="FALSE REPORT" /> False Report</label>
                <label for="ot16"><input class="otypes" type="checkbox" id="ot16" value="FIREWORK" /> Firework</label>
                <label for="ot17"><input class="otypes" type="checkbox" id="ot17" value="FORGERY" /> Forgery</label>
                <label for="ot18"><input class="otypes" type="checkbox" id="ot18" value="FRAUD" /> Fraud</label>
                <label for="ot19"><input class="otypes" type="checkbox" id="ot19" value="HARBOR CALLS" /> Harbor Calls</label>
                <label for="ot20"><input class="otypes" type="checkbox" id="ot20" value="HOMICIDE" /> Homicide</label>
                <label for="ot21"><input class="otypes" type="checkbox" id="ot21" value="ILLEGAL DUMPING" /> Illegal Dumping</label>
                <label for="ot22"><input class="otypes" type="checkbox" id="ot22" value="INJURY" /> Injury</label>
                <label for="ot23"><input class="otypes" type="checkbox" id="ot23" value="LIQUOR VIOLATION" /> Liquor Violation</label>
                <label for="ot24"><input class="otypes" type="checkbox" id="ot24" value="LOITERING" /> Loitering</label>
                <label for="ot25"><input class="otypes" type="checkbox" id="ot25" value="LOST PROPERTY" /> Lost Property</label>
                <label for="ot26"><input class="otypes" type="checkbox" id="ot26" value="MAIL THEFT" /> Mail Theft</label>
                <label for="ot27"><input class="otypes" type="checkbox" id="ot27" value="NARCOTICS" /> Narcotics</label>
                <label for="ot28"><input class="otypes" type="checkbox" id="ot28" value="OBSTRUCT" /> Obstruct</label>
                <label for="ot29"><input class="otypes" type="checkbox" id="ot29" value="OTHER PROPERTY" /> Other Property</label>
                <label for="ot30"><input class="otypes" type="checkbox" id="ot30" value="PICKPOCKET" /> Pickpocket</label>
                <label for="ot31"><input class="otypes" type="checkbox" id="ot31" value="PROPERTY DAMAGE" /> Property Damage</label>
                <label for="ot32"><input class="otypes" type="checkbox" id="ot32" value="PROSTITUTION" /> Prostitution</label>
                <label for="ot33"><input class="otypes" type="checkbox" id="ot33" value="PUBLIC NUISANCE" /> Public Nuisance</label>
                <label for="ot34"><input class="otypes" type="checkbox" id="ot34" value="PURSE SNATCH" /> Purse Snatch</label>
                <label for="ot35"><input class="otypes" type="checkbox" id="ot35" value="RECKLESS BURNING" /> Reckless Burning</label>
                <label for="ot36"><input class="otypes" type="checkbox" id="ot36" value="RECOVERED PROPERTY" /> Recovered Property</label>
                <label for="ot37"><input class="otypes" type="checkbox" id="ot37" value="ROBBERY" /> Robbery</label>
                <label for="ot38"><input class="otypes" type="checkbox" id="ot38" value="SHOPLIFTING" /> Shoplifting</label>
                <label for="ot39"><input class="otypes" type="checkbox" id="ot39" value="STAY OUT OF AREA OF DRUGS" /> Stay Out of Drug Areas</label>
                <label for="ot40"><input class="otypes" type="checkbox" id="ot40" value="STOLEN PROPERTY" /> Stolen Property</label>
                <label for="ot41"><input class="otypes" type="checkbox" id="ot41" value="THEFT OF SERVICES" /> Theft of Services</label>
                <label for="ot42"><input class="otypes" type="checkbox" id="ot42" value="THREATS" /> Threats</label>
                <label for="ot43"><input class="otypes" type="checkbox" id="ot43" value="TRAFFIC" /> Traffic</label>
                <label for="ot44"><input class="otypes" type="checkbox" id="ot44" value="TRESPASS" /> Trespass</label>
                <label for="ot45"><input class="otypes" type="checkbox" id="ot45" value="VEHICLE THEFT" /> Vehicle Theft</label>
                <label for="ot46"><input class="otypes" type="checkbox" id="ot46" value="VIOLATION OF COURT ORDER" /> Violation of Court Order</label>
                <label for="ot47"><input class="otypes" type="checkbox" id="ot47" value="WARRANT ARREST" /> Warrant Arrest</label>
                <label for="ot48"><input class="otypes" type="checkbox" id="ot48" value="WEAPON" /> Weapon</label>
            </div>
        </div>
        <span id="filters">
            <span><label for="month_filter">Month: <select id="month_filter">
                <option selected value="0">all months</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select></label></span>
        <span><label for="year_filter">Year: <select id="year_filter">
                <option selected value="0">all years</option>
                <option value="2008">2008</option>
                <option value="2009">2009</option>
                <option value="2010">2010</option>
                <option value="2011">2011</option>
                <option value="2012">2012</option>
                <option value="2013">2013</option>
                <option value="2014">2014</option>
                <option value="2015">2015</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
            </select></label></span>
        <span>
                <label for="timeInput">Time: <input disabled type="range" list="tickmarks" name="InputName" id="timeInput" value="-1" min="0" max="23" oninput="convert_time(this)"></label>
                <datalist id="tickmarks">
                    <option value="0">
                    <option value="1">
                    <option value="2">
                    <option value="3">
                    <option value="4">
                    <option value="5">
                    <option value="6">
                    <option value="7">
                    <option value="8">
                    <option value="9">
                    <option value="10">
                    <option value="11">
                    <option value="12">
                    <option value="13">
                    <option value="14">
                    <option value="15">
                    <option value="16">
                    <option value="17">
                    <option value="18">
                    <option value="19">
                    <option value="20">
                    <option value="21">
                    <option value="22">
                    <option value="23">
                </datalist>
                <output name="OutputName" id="timeOutput"></output><font id="ampm">&nbsp;&nbsp;OFF&nbsp;</font> 
                <label class="switch"><input type="checkbox" id="activate_time_filter" value="true" onchange="active_time(this)" /><span class="slider round"></span></label>
        </span>
        <span><button onclick="initMap();" class="tool mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect" id="add_button"><i class="material-icons">+</i></button></span>
        </span>
    </div>
    <div id="content">
        <span class="sub-container"></span>
        <span id="Lmap"></span>
        <span class="sub-container" id="plotly"></span>
    </div>

</body>
<script>
    function toggle(source) {
        var checkboxes = document.getElementsByClassName("otypes");
        for (var i = 0, n = checkboxes.length; i < n; ++i) {
            checkboxes[i].checked = source.checked;
        }
    }

    function showCheckboxes() {
        var checkboxes = document.getElementById("checkboxes");
        checkboxes.style.display = "block";
    }

    function hideCheckboxes() {
        var checkboxes = document.getElementById("checkboxes");
        checkboxes.style.display = "none";
    }

    function active_time(source) {
        var input = document.getElementById("timeInput");
        var output = document.getElementById("timeOutput");
        var ampm = document.getElementById("ampm");
        if (source.checked) {
            input.disabled = false;
            output.value = 12;
            ampm.innerHTML = " AM";
        }
        else {
            input.value = -1;
            output.value = "";
            ampm.innerHTML = '&nbsp;' + '&nbsp;' + "OFF" + '&nbsp;';
            input.disabled = true;
        }
    }

    function convert_time(source) {
        var output = document.getElementById("timeOutput");
        var ampm = document.getElementById("ampm");
        if (source.value > 12) {
            output.value = (source.value) - 12;
            if (output.value < 10) {
                output.value = "0" + String(output.value);
            }
            ampm.innerHTML = " PM";
        }
        else if (source.value == 0) {
            output.value = 12;
            ampm.innerHTML = " AM";
        }
        else if (source.value == 12) {
            output.value = 12;
            ampm.innerHTML = " PM";
        }
        else {
            output.value = source.value;
            if (output.value < 10) {
                output.value = "0" + String(output.value);
            }
            ampm.innerHTML = " AM";
        }
    }

    var bounds = null;

    function initMap() {
        var totalCount = 0;
        var count = [];
        var otypes_group = [];
        var otypes = document.getElementsByClassName('otypes');
        var len = 0;
        var data = [];
        var colors = [];

        document.getElementById("Lmap").innerHTML = "<div id='map'></div>";

        var map = new L.map(
            'map', {
                center: [47.6610, -122.309],
                zoom: 14,
                maxBounds: bounds,
                layers: [],
                worldCopyJump: false,
                crs: L.CRS.EPSG3857
            });

        var tile_layer = new L.tileLayer(
            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                "attribution": null,
                "detectRetina": false,
                "maxZoom": 18,
                "minZoom": 1,
                "noWrap": false,
                "subdomains": "abc"
            }).addTo(map);

        var HERE_normalDay = L.tileLayer('https://{s}.{base}.maps.cit.api.here.com/maptile/2.1/{type}/{mapID}/normal.day/{z}/{x}/{y}/{size}/{format}?app_id={app_id}&app_code={app_code}&lg={language}', {
            attribution: 'Map &copy; 1987-2014 <a href="http://developer.here.com">HERE</a>',
            subdomains: '1234',
            mapID: 'newest',
            app_id: '<your app_id>',
            app_code: '<your app_code>',
            base: 'base',
            maxZoom: 18,
            type: 'maptile',
            language: 'eng',
            format: 'png8',
            size: '256'
        }).addTo(map);

        function filters(feature) {
            var months = document.getElementById('month_filter');
            var s_month = months.options[months.selectedIndex].value;
            var years = document.getElementById('year_filter');
            var s_year = years.options[years.selectedIndex].value;
            var times = document.getElementById('timeInput');
            var s_time = times.value;
            var position = 0;
            var color;
            var type;
            for (var i = 0; otypes[i]; ++i) {
                if (otypes[i].checked && (feature.properties.otype == otypes[i].value) && (feature.properties.Month == s_month || s_month == 0) &&
                    (feature.properties.Year == s_year || s_year == 0) && (feature.properties.hour == s_time || times.disabled == true)) {
                    position = feature.properties.hour;
                    color = feature.properties.color;
                    if (colors.indexOf(color) == -1) {
                        len++;
                        colors.push(color);
                        otypes_group.push(feature.properties.otype);
                        count.push(Array.apply(null, Array(24)).map(Number.prototype.valueOf, 0));
                    }
                    count[colors.indexOf(color)][position]++;
                    return true;
                }
            }
        }
        
        var marker_cluster = L.markerClusterGroup({});

        var points = new L.geoJSON(df, {
            filter: filters,
            pointToLayer: function(feature, latlng) {
                totalCount = totalCount + 1;
                return L.circleMarker(latlng, { radius: 7, fillColor: feature.properties.color, color: "#000", weight: 0.3, opacity: 1, fillOpacity: 1 });
            },
            onEachFeature: function(feature, layer) {
                layer.bindPopup(feature.properties.text.toString());
            }
        }).addTo(marker_cluster);
        
        map.addLayer(marker_cluster);
        
        var layer_control = {
            base_layers: { "Base Map": HERE_normalDay, },
            overlays: { "Clusters": marker_cluster, }
        };
        
        L.control.layers(
            layer_control.base_layers,
            layer_control.overlays, {
                position: 'topleft',
                collapsed: true,
                autoZIndex: true
            }).addTo(map);

        document.getElementById("totalCountOut").innerHTML = totalCount;

        for (var k = 0; k < len; ++k) {
            data.push({
                x: count[k],
                y: ['12AM', '1AM', '2AM', '3AM', '4AM', '5AM', '6AM', '7AM', '8AM', '9AM', '10AM', '11AM',
                    '12PM', '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', '9PM', '10PM', '11PM'
                ],
                width: 0.5,
                autosize: true,
                name: otypes_group[k],
                type: 'bar',
                text: count,
                textfont: {
                    size: 9
                },
                hoverinfo: 'none',
                orientation: 'h',
                marker: {
                    color: colors[k],
                },
            });
        }

        var layout = {
            width: 600,
            margin: {
                l: 50,
                r: 15,
                b: 15,
                t: 35,
            },
            barmode: 'stack',
            title: '<b>Number of Incidents Reported by Time of the Day</b><br><s>2008-2018</s>',
            xaxis: {
                title: '',
                showticklabels: true,
            },
            yaxis: {
                autorange: 'reversed',
                tickfont: {
                    size: 13,
                },
            },
        };
        Plotly.newPlot('plotly', data, layout);
    }
</script>
</body>

</html>
